name: CI

on:
  push:
  pull_request:

jobs:
  api-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Import smoke test
        run: |
          python -c "import src.main"

      - name: Pytest
        env:
          PYTHONPATH:
        run: |
          pytest -q

  docker-compose-smoke:
    runs-on: ubuntu-latest
    env:
      OPS_API_TOKEN: ci-token
      NEXT_PUBLIC_OPS_TOKEN: ci-token
      NEXT_PUBLIC_API_BASE: http://api:8001

    steps:
      - uses: actions/checkout@v4

      - name: Build and start (compose)
        run: |
          docker compose up -d --build

      - name: Wait for API
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8001/health > /dev/null; then
              echo "API is up"
              exit 0
            fi
            echo "Waiting for API..."
            sleep 2
          done
          echo "API did not become ready in time"
          docker compose ps
          docker compose logs --no-color
          exit 1

      - name: Smoke test (API)
        env:
          PYTHONPATH:
        run: |
          curl -fsS http://localhost:8001/health
          curl -fsS http://localhost:8001/metrics
          curl -fsS -H "X-Ops-Token: ci-token" "http://localhost:8001/events?limit=1"
          curl -fsS -H "Content-Type: application/json" -H "X-Ops-Token: ci-token" \
            -d '{"level":"INFO","type":"OPS","service":"ci","message":"ci smoke event","meta":{"source":"github-actions"}}' \
            http://localhost:8001/events
          curl -fsS -H "X-Ops-Token: ci-token" http://localhost:8001/events/summary

      - name: Wait for UI
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:3000 > /dev/null; then
              echo "UI is up"
              exit 0
            fi
            echo "Waiting for UI..."
            sleep 2
          done
          echo "UI did not become ready in time"
          docker compose ps
          docker compose logs --no-color
          exit 1

      - name: Smoke test (UI)
        run: |
          curl -fsS http://localhost:3000 > /dev/null

      - name: Logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color

      - name: Shutdown
        if: always()
        run: docker compose down